\chapter{\label{chap:spelunkbots}SpelunkBots}
Em 2014, Daniel Scales e Thomas Thompson, da Universidade de Derby no Reino
Unido, criaram o \textit{SpelunkBots}\cite{SPELUNKBOTSPAPER}, um
\textit{framework} que permite a programação de \textit{bots} para o jogo
Spelunky. Um dos objetivos dos criadores é utilizar a aplicação para criar uma
competição de inteligência artificial para o jogo. O \textit{framework} foi
desenvolvido utilizando uma combinação do código-fonte original do jogo
\textit{Spelunky} -- distribuído gratuítamente no \textit{website}
oficial\footnote{http://www.spelunkyworld.com/original.htm} --, o motor de
criação de jogos \textit{GameMaker} e uma solução \textit{DLL} programada com a
linguagem C++.


%----------
\section{\label{section:spelunkbots-usage}Modo de Uso}
Como o \textit{framework} possui acesso irrestrito ao código-fonte de
\textit{Spelunky}, a opção de programar a inteligência artificial utilizando a
linguagem de programação padrão do \textit{GameMaker}, a \textit{GML}, foi
incluida pelos criadores do programa. Esta linguagem foi criada com o intuito de
fornecer a desenvolvedores de jogos iniciantes uma maneira fácil e rápida de
programar jogos e, justamente por este motivo, apresenta diversas limitações de
linguagem e não possui muitas bibliotecas auxiliares. Além disso, os arquivos
\textit{.gml} só podem ser editados dentro do ambiente de programação interno do
\textit{GameMaker}. Assim, esta opção de desenvolvimento não é adequada a
programadores mais experientes.

Sabendo que o \textit{GameMaker} é capaz de executar código externo através de
\textit{Dynamic-link Libraries} (\textit{DLLS}), os autores desenvolveram um
projeto em C++ que gera uma solução no formato \textit{DLL} para permitir que os
usuários possam programar \textit{bots} utilizando a linguagem de programação
C++. Para programar em C++, portanto,  é necessário fazer uso de uma ferramenta de
compilação externa para gerar a solução \textit{DLL}. O \textit{SpelunkBots}
fornece um projeto em \textit{Visual Studio 2013} -- ambiente de programação
desenvolvido pela \textit{Microsoft} -- para auxiliar neste processo.

Assim, existem duas maneiras de se utilizar o \textit{SpelunkBots} para
programar uma inteligência artificial para \textit{Spelunky}: internamente,
através do \textit{GameMaker} e da \textit{GML}, ou externamente, através da
solução \textit{DLL} em C++. Desta maneira, o \textit{framework} fica acessível
tanto para programadores iniciantes quanto para programadores experientes.  A
Figura \ref{fig:spelunkbots-usage-diagram} ilustra a relação entre o
\textit{Spelunky}, o \textit{SpelunkBots} e as formas disponíveis de se realizar
a programação dos \textit{bots}.

\begin{figure}[htb!]
\centering
\begin{tikzpicture}[
    every node/.style={
        minimum width=4cm, minimum height=3em,
        text width=4cm,
        text centered,
        font=\small
    },
    box/.style={
        draw, rectangle,
        minimum width=5.3cm
    },
    inner box/.style={
        draw, rectangle
    }
]
    \matrix[row sep=1cm, column sep=1.5cm] {
        \node[rectangle] (spl) {Spelunky};                    &
                                                              &
        \\
        \node[inner box] (spb) {SpelunkBots};                 &
        \node[box]       (gml) {Código em GML};               &
        \\
        \node[box]       (dll) {Solução de DLLs do Spelunky}; &
        \node[box]       (c++) {Código em C++};
        \\
    };
    \node[draw, inner sep=.5cm, fit={(spl) (spb)}] {};

    \draw[->,>=latex] (gml.west) -- (spb.east);
    \draw[->,>=latex] (dll.north) -- (spb.south);
    \draw[->,>=latex] (c++.west) -- (dll.east);
\end{tikzpicture}
\caption {\label{fig:spelunkbots-usage-diagram}Diagrama exibindo a relação
entre o jogo Spelunky, a API SpelunkyBots e as linguagens de programação que
podem ser usadas para a interação com o jogo.}
\end{figure}


%----------
\section{Configurações da Ferramenta}
Antes de tentar executar o \textit{SpelunkBots}, é necessário entender como
realizar as configurações da ferramenta. As principais configurações que o
usuário deve modificar são a \textbf{escolha do \textit{bot}} a ser executado e
o \textbf{tipo de teste} no qual o \textit{bot} vai executar. Estas modificações
são efetuadas dentro do \textit{GameMaker} no projeto do \textit{framework},
chamado \textit{spelunkbots.gmk}.

É possível que o usuário sinta a necessidade de desenvolver mais de uma
inteligência artificial ao mesmo tempo durante o uso da ferramenta.  Por
exemplo, pode desejar tentar solucionar diversos problemas específicos ou
realizar outros experimentos sem modificar o código-fonte do \textit{bot}
principal.  Para escolher o \textit{bot} que será executado, o usuário deve
modificar o arquivo de \textit{script} \textit{PlayerChoice} para escolher o
\textit{bot} que deseja testar.

Existem dois modos de execução em \textit{SpelunkBots}: o modo \textbf{TestMaps}
e o modo \textbf{Marathon}. No primeiro, a ferramenta executa o \textit{bot} em
uma série de mapas customizados, escolhidos pelo usuário. Este modo é perfeito
para testar as capacidades do \textit{bot} em cenários específicos ou difíceis
de encontrar durante uma partida comum. Já no segundo, executa o \textit{bot} em
uma série de mapas comuns, utilizando uma lista de sementes definidas pelo
usuário. Como as sementes são repassadas para o gerador de números
pseudo-aleatórios do algoritmo de geração de níveis, os \textit{layouts} dos
níveis serão sempre os mesmos -- definidos pelas sementes. Este modo é ótimo
para testar o \textit{bot} em mapas normais do jogo, mas para ser bem sucedido,
a inteligência artificial deve estar muito preparada. Para escolher o modo de
execução (e outros parâmetros relacionados, como número de execuções e tempo
limite por nível), o usuário deve modificar o arquivo de \textit{script}
\textit{LevelParameters}.


%----------
\section{Recebendo Informações do Jogo}
Uma das funcionalidades mais importantes da ferramenta é a disponibilização das
informações do jogo durante sua execução. As informações do jogo são divididas
em três grupos: \textbf{nodos}, \textbf{inimigos} e \textbf{objetos}:

\begin{description}
	\item[Nodo]
		O mapa do nível é dividido em nodos, e cada um destes nodos possui um
		tipo.  Para receber o tipo de um nodo em específico, a função da
		\textit{API} \textit{GetNodeState} deve ser chamada. Existe um total de
		1428 nodos em um mapa de \textit{Spelunky}.

	\item[Inimigos]
		Existem diversos tipos de inimigos em \textit{Spelunky}, e saber a
		localização deles é extremamente importante. Assim como as informações
		de nodo, cada inimigo possui um tipo associado a ele. Para determinar se
		um nodo possui um inimigo em específico, a função da \textit{API}
		\textit{GetIDOfEnemyInNode} deve ser usada.

	\item[Objetos]
		Em \textit{Spelunky}, existem diversos objetos com os quais o jogador
		pode interagir das mais diversas maneiras. Cada objeto possui um tipo
		associado a ele, para facilitar na distinção. Para determinar se um nodo
		possui um objeto em específico, a função da \textit{API}
		\textit{GetIDOfCollectableInNode} deve ser usada.
\end{description}

Além destas informações, o usuário pode receber dados sobre o estado do
\textit{bot}, como saber suas coordenadas, se ele está no ar, se movendo para a
direita ou esquerda, se ele está pendurado, entre outras. O apêndice
\ref{appendix:spelunkbots-variables} detalha os tipos de nodos, inimigos e
objetos e informações do estado do jogador.

\subsection{Sistema de \textit{Fog of War}}
Apesar de possibilitar ao desenvolvedor o resgate de informações sobre o jogo,
como o terreno, a posição de tesouros, armadilhas e inimigos, o objetivo do
\textit{framework} é fazer com que a informação recebida pelo \textit{bot} se
assemelhe ao máximo com a percepção de um jogador humano. Para tal, um sistema
de névoa de batalha (\textit{fog of war}) foi implementado, que serve para
limitar o conhecimento do ambiente que pode ser obtido pela inteligência
artificial.

Para objetos estáticos, uma vez que o jogador visualizou o objeto, ele poderá
receber informações sobre ele permanentemente. Um exemplo de objeto estático é o
terreno. Já para objetos dinâmicos, o \textit{bot} só receberá informações sobre
eles se estiverem sendo visualizados (dentro da tela do jogo) naquele momento.
Um exemplo de objeto dinâmico são os inimigos A Figura \ref{fig:spelunkbots-fow}
ilustra um exemplo de funcionamento do sistema, onde a área com o fundo nevoado
corresponde ao sistema de \textit{fog of war}.

\begin{figure}[htb!]
\centering
\includegraphics[width=.65\textwidth]{fig/spelunkbots-fow.png}
\caption {Visualização do sistema de \textit{fog of war} demonstrando a
diferença de informação recebida de elementos dentro e fora do campo de visão do
jogador.}
\label{fig:spelunkbots-fow}
\end{figure}


%----------
\section{Enviando Comandos para o \textit{Bot}}
Outra parte crucial da ferramenta é o envio de comandos para o \textit{bot}
durante a execução do jogo. Em \textit{SpelunkBots}, o envio de comandos é
controlado por uma série de variáveis \textit{booleanas} que estão mapeadas, uma
para uma, para os botões de controle (este mapeamento é apresentado no apêndice
\ref{appendix:spelunkbots-variables}). A cada etapa de execução, o usuário deve
modificar tais variáveis para \textit{verdadeiro} ou \textit{falso}, informando
para o \textit{framework} que comandos executar com o personagem.

O usuário não precisa se preocupar em reiniciar as variáveis de controle a cada
passo de execução, pois o programa já se encarrega disso: a cada fim de etapa de
execução, todas as variáveis são reiniciadas para o valor \textit{falso}. Ou
seja, se o usuário não enviar comandos em \textbf{todas as etapas de execução},
o \textit{bot} não se movimentará corretamente.
